@model AdminDashboardViewModel
@using System.Linq
@{
    ViewData["Title"] = "Panel de administracion";
    string FechaCorta(DateTimeOffset fecha) => fecha.ToLocalTime().ToString("dd/MM/yyyy HH:mm");
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h1 class="h3 mb-0">Panel de control</h1>
        <p class="text-muted mb-0">Vision general de actividad y seguridad del sistema.</p>
    </div>
    <span class="badge bg-warning text-dark align-self-start">Solo administradores</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <p class="text-muted mb-1">Ventas registradas</p>
                <h4 class="mb-0 fw-bold">@Model.TotalVentas</h4>
                <small class="text-muted">Ultimas 5 en la tabla de abajo</small>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <p class="text-muted mb-1">Movimientos de stock</p>
                <h4 class="mb-0 fw-bold">@Model.TotalMovimientosStock</h4>
                <small class="text-muted">Ingresos: @Model.TotalMovimientosIngreso | Egresos: @Model.TotalMovimientosEgreso</small>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <p class="text-muted mb-1">Productos activos</p>
                <h4 class="mb-0 fw-bold">@Model.TotalProductos</h4>
                <small class="text-muted">Inactivos/baja: @Model.ProductosInactivos</small>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <p class="text-muted mb-1">Admins monitoreando</p>
                <h4 class="mb-0 fw-bold">@Model.AdministradoresActivos.Count</h4>
                <small class="text-muted">Usuarios con rol Administrador</small>
            </div>
        </div>
    </div>
</div>

@if (Model.AlertasSeguridad != null && Model.AlertasSeguridad.Count > 0)
{
    <div class="alert alert-warning shadow-sm">
        <h6 class="alert-heading">Alertas de seguridad y control</h6>
        <ul class="mb-0">
            @foreach (var alerta in Model.AlertasSeguridad)
            {
                <li>@alerta</li>
            }
        </ul>
    </div>
}

<div class="row g-4">
    <div class="col-12 col-lg-7">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ventas recientes</h5>
                    <a asp-controller="Venta" asp-action="Historial" class="btn btn-outline-primary btn-sm">Ver historial</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Pago</th>
                                <th>Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.UltimasVentas.Any())
                            {
                                foreach (var v in Model.UltimasVentas)
                                {
                                    <tr>
                                        <td>#@v.Id</td>
                                        <td>@FechaCorta(v.Fecha)</td>
                                        <td>@v.TipoPago</td>
                                        <td>$ @v.Total.ToString("N2")</td>
                                        <td>
                                            <span class="@($"badge {(v.Estado == "CONFIRMADA" ? "bg-success" : "bg-secondary")}")">@v.Estado</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-center text-muted py-3">Sin ventas registradas</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-5">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Movimientos de stock</h5>
                <a asp-controller="Stock" asp-action="Index" class="btn btn-outline-primary btn-sm">Ver todos</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Cant.</th>
                                <th>Producto</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.UltimosMovimientosStock.Any())
                            {
                                foreach (var m in Model.UltimosMovimientosStock)
                                {
                                    <tr>
                                        <td>@FechaCorta(m.Fecha)</td>
                                        <td>
                                            <span class="@($"badge {(m.Tipo == "INGRESO" ? "bg-success" : "bg-danger")}")">@m.Tipo</span>
                                        </td>
                                        <td>@m.Cantidad</td>
                                        <td>#@m.ProductoId</td>
                                        <td class="text-muted">@(!string.IsNullOrWhiteSpace(m.Motivo) ? m.Motivo : "-")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-center text-muted py-3">Sin movimientos recientes</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Altas de productos</h5>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.UltimasAltas.Any())
                {
                    foreach (var p in Model.UltimasAltas)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">@p.Nombre</div>
                                    <small class="text-muted">SKU: @p.Sku</small>
                                </div>
                                <small class="text-muted">@FechaCorta(p.CreatedAt)</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">Sin altas registradas.</div>
                }
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Bajas / inactivaciones</h5>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.UltimasBajas.Any())
                {
                    foreach (var p in Model.UltimasBajas)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">@p.Nombre</div>
                                    <small class="text-muted">SKU: @p.Sku</small>
                                </div>
                                <small class="text-muted">@FechaCorta(p.UpdatedAt)</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">Sin bajas registradas.</div>
                }
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Modificaciones de productos</h5>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.UltimasEdiciones.Any())
                {
                    foreach (var p in Model.UltimasEdiciones)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">@p.Nombre</div>
                                    <small class="text-muted">SKU: @p.Sku</small>
                                </div>
                                <small class="text-muted">@FechaCorta(p.UpdatedAt)</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">Sin modificaciones recientes.</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mt-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Seguridad y roles</h5>
        <a asp-controller="Usuario" asp-action="Index" class="btn btn-outline-primary btn-sm">Gestionar usuarios</a>
    </div>
    <div class="card-body">
        <p class="text-muted">Administradores activos con acceso total al sistema.</p>
        @if (Model.AdministradoresActivos.Any())
        {
            <div class="row g-2">
                @foreach (var admin in Model.AdministradoresActivos)
                {
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="border rounded p-2 h-100">
                            <div class="fw-semibold">@admin.Nombre</div>
                            <small class="text-muted">@admin.Email</small>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-danger mb-0">No se encontraron administradores activos. Revisa la configuracion de roles.</div>
        }
    </div>
</div>
