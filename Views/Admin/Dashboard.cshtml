@model AdminDashboardViewModel
@using System.Linq
@{
    ViewData["Title"] = "Panel de administracion";
    string FechaCorta(DateTimeOffset fecha) => fecha.ToLocalTime().ToString("dd/MM/yyyy HH:mm");
}

<div class="d-flex align-items-center justify-content-between mb-3">
    <div>
        <h1 class="h3 mb-0">Panel de control</h1>
        <p class="text-muted mb-0">Vision general de actividad y seguridad del sistema.</p>
    </div>
    <span class="badge bg-warning text-dark align-self-start">Solo administradores</span>
</div>

<style>
    .hover-card {
        transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
    }
    .hover-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 0.85rem 1.35rem rgba(13, 110, 253, 0.25);
        background-color: #f8f9ff;
    }
    .hover-card:active {
        transform: translateY(-1px) scale(0.99);
    }
    .dashboard-table-wrapper {
        border: 1px solid #e5e7eb;
        border-radius: 0.65rem;
        overflow: hidden;
        box-shadow: 0 0.35rem 0.8rem rgba(15, 23, 42, 0.08);
        background: #fff;
    }
    .dashboard-table {
        margin-bottom: 0;
    }
    .dashboard-table thead th {
        background: linear-gradient(90deg, #0d6efd, #0b5ed7);
        color: #fff;
        border-color: #0b5ed7 !important;
        letter-spacing: 0.01em;
        text-transform: uppercase;
        font-size: 0.85rem;
    }
    .dashboard-table tbody tr:nth-child(odd) td {
        background-color: #f5f8ff;
    }
    .dashboard-table tbody tr:nth-child(even) td {
        background-color: #ffffff;
    }
    .dashboard-table tbody tr:hover td {
        background-color: #e3edff;
    }
    .dashboard-table tbody td {
        border-color: #e5e7eb;
    }
    .dashboard-table thead th,
    .dashboard-table tbody td {
        padding: 0.9rem 0.75rem;
    }
    .dashboard-table tbody tr {
        height: 3.25rem;
    }
    .table-row-link {
        cursor: pointer;
    }
    .table-row-link:active td {
        opacity: 0.92;
    }
</style>

<div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-lg-3">
        <a class="text-decoration-none" asp-controller="Venta" asp-action="Historial">
            <div class="card shadow-sm h-100 hover-card">
                <div class="card-body">
                    <p class="text-muted mb-1">Ventas registradas</p>
                    <h4 class="mb-0 fw-bold">@Model.TotalVentas</h4>
                    <small class="text-muted">Ir al historial</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <a class="text-decoration-none" asp-controller="Stock" asp-action="Index">
            <div class="card shadow-sm h-100 hover-card">
                <div class="card-body">
                    <p class="text-muted mb-1">Movimientos de stock</p>
                    <h4 class="mb-0 fw-bold">@Model.TotalMovimientosStock</h4>
                    <small class="text-muted">Ingresos: @Model.TotalMovimientosIngreso | Egresos: @Model.TotalMovimientosEgreso</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-sm h-100 hover-card">
            <div class="card-body">
                <p class="text-muted mb-1">Ventas del dia</p>
                <h4 class="mb-0 fw-bold">@Model.UltimasVentas.Where(v => v.Fecha.Date == DateTimeOffset.UtcNow.Date).Sum(v => v.Total).ToString("C")</h4>
                <small class="text-muted">Total del día</small>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <a class="text-decoration-none" asp-controller="Usuario" asp-action="Index">
            <div class="card shadow-sm h-100 hover-card">
                <div class="card-body">
                    <p class="text-muted mb-1">Admins monitoreando</p>
                    <h4 class="mb-0 fw-bold">@Model.AdministradoresActivos.Count</h4>
                    <small class="text-muted">Ir a usuarios</small>
                </div>
            </div>
        </a>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
        <a class="text-decoration-none" asp-controller="Stock" asp-action="Criticos">
            <div class="card shadow-sm h-100 hover-card">
                <div class="card-body">
                    <p class="text-muted mb-1">Stock crítico</p>
                    <h4 class="mb-0 fw-bold">@Model.ProductosStockCritico</h4>
                    <small class="text-muted">Ver listado urgente</small>
                </div>
            </div>
        </a>
    </div>
</div>

@if (Model.AlertasSeguridad != null && Model.AlertasSeguridad.Count > 0)
{
    <div class="alert alert-warning shadow-sm">
        <h6 class="alert-heading">Alertas de seguridad y control</h6>
        <ul class="mb-0">
            @foreach (var alerta in Model.AlertasSeguridad)
            {
                <li>@alerta</li>
            }
        </ul>
    </div>
}

<div class="row g-4">
    <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ventas recientes</h5>
                    <a asp-controller="Venta" asp-action="Historial" class="btn btn-outline-primary btn-sm">Ver historial</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive dashboard-table-wrapper">
                    <table class="table table-hover mb-0 align-middle dashboard-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Fecha</th>
                                <th>Pago</th>
                                <th>Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.UltimasVentas.Any())
                            {
                                foreach (var v in Model.UltimasVentas)
                                {
                                    var detalleUrl = Url.Action("Comprobante", "Venta", new { id = v.Id });
                                    <tr class="table-row-link" role="button" onclick="window.location.href='@detalleUrl'">
                                        <td>#@v.Id</td>
                                        <td>@FechaCorta(v.Fecha)</td>
                                        <td>@v.TipoPago</td>
                                        <td>$ @v.Total.ToString("N2")</td>
                                        <td>
                                            <span class="@($"badge {(v.Estado == "CONFIRMADA" ? "bg-success" : "bg-secondary")}")">@v.Estado</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-center text-muted py-3">Sin ventas registradas</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Movimientos de stock</h5>
                <a asp-controller="Stock" asp-action="Movimientos" class="btn btn-outline-primary btn-sm">Ver todos</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive dashboard-table-wrapper">
                    <table class="table table-sm mb-0 align-middle dashboard-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Cant.</th>
                                <th>Producto</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.UltimosMovimientosStock.Any())
                            {
                                foreach (var m in Model.UltimosMovimientosStock)
                                {
                                    var nombreProducto = (Model.ProductosPorId != null && Model.ProductosPorId.TryGetValue(m.ProductoId, out var nombre))
                                        ? nombre
                                        : $"ID #{m.ProductoId}";
                                    var movimientosUrl = Url.Action("Manage", "StockProducto", new { id = m.ProductoId });
                                    <tr class="table-row-link" role="button" onclick="window.location.href='@movimientosUrl'">
                                        <td>@FechaCorta(m.Fecha)</td>
                                        <td>
                                            <span class="@($"badge {(m.Tipo == "INGRESO" ? "bg-success" : "bg-danger")}")">@m.Tipo</span>
                                        </td>
                                        <td>@m.Cantidad</td>
                                        <td>@nombreProducto</td>
                                        <td class="text-muted">@(!string.IsNullOrWhiteSpace(m.Motivo) ? m.Motivo : "-")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-center text-muted py-3">Sin movimientos recientes</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Productos en stock crítico</h5>
                <a asp-controller="Stock" asp-action="Criticos" class="btn btn-outline-danger btn-sm">Ver listado</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive dashboard-table-wrapper">
                    <table class="table table-sm mb-0 align-middle dashboard-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Stock</th>
                                <th>Mínimo</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if (Model.ProductosCriticosDestacados != null && Model.ProductosCriticosDestacados.Any())
                        {
                            foreach (var prod in Model.ProductosCriticosDestacados)
                            {
                                <tr class="table-row-link" role="button" onclick="window.location.href='@Url.Action("Manage","StockProducto", new { id = prod.Id })'">
                                    <td>#@prod.Id</td>
                                    <td>@prod.Nombre</td>
                                    <td>@prod.StockActual</td>
                                    <td>@prod.StockMinimo</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="4" class="text-center text-muted py-3">Sin alertas críticas</td></tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Altas de productos</h5>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.UltimasAltas.Any())
                {
                    foreach (var p in Model.UltimasAltas)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">@p.Nombre</div>
                                    <small class="text-muted">SKU: @p.Sku</small>
                                </div>
                                <small class="text-muted">@FechaCorta(p.CreatedAt)</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">Sin altas registradas.</div>
                }
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Bajas / inactivaciones</h5>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.UltimasBajas.Any())
                {
                    foreach (var p in Model.UltimasBajas)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">@p.Nombre</div>
                                    <small class="text-muted">SKU: @p.Sku</small>
                                </div>
                                <small class="text-muted">@FechaCorta(p.UpdatedAt)</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">Sin bajas registradas.</div>
                }
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white">
                <h5 class="mb-0">Modificaciones de productos</h5>
            </div>
            <div class="list-group list-group-flush">
                @if (Model.UltimasEdiciones.Any())
                {
                    foreach (var p in Model.UltimasEdiciones)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">@p.Nombre</div>
                                    <small class="text-muted">SKU: @p.Sku</small>
                                </div>
                                <small class="text-muted">@FechaCorta(p.UpdatedAt)</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="list-group-item text-muted">Sin modificaciones recientes.</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mt-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Seguridad y roles</h5>
        <a asp-controller="Usuario" asp-action="Index" class="btn btn-outline-primary btn-sm">Gestionar usuarios</a>
    </div>
    <div class="card-body">
        <p class="text-muted">Administradores activos con acceso total al sistema.</p>
        @if (Model.AdministradoresActivos.Any())
        {
            <div class="row g-2">
                @foreach (var admin in Model.AdministradoresActivos)
                {
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="border rounded p-2 h-100">
                            <div class="fw-semibold">@admin.Nombre</div>
                            <small class="text-muted">@admin.Email</small>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-danger mb-0">No se encontraron administradores activos. Revisa la configuracion de roles.</div>
        }
    </div>
</div>
