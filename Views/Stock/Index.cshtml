@using mi_ferreteria.Models
@{
    ViewData["Title"] = "Gestion de Stock";
    var movimientos = ViewBag.Movimientos as IEnumerable<StockMovimiento> ?? Enumerable.Empty<StockMovimiento>();
    var prodNames = ViewBag.ProductNames as System.Collections.Generic.IDictionary<long, string> ?? new System.Collections.Generic.Dictionary<long, string>();
    int page = ViewBag.Page is int p ? p : 1;
    int total = ViewBag.TotalCount is int t ? t : movimientos.Count();
    int totalPages = ViewBag.TotalPages is int tp ? tp : 1;
}
<h2 class="mb-3">Gestion de Stock</h2>

<div class="card">
  <div class="card-header bg-primary text-white">Ultimos movimientos de stock</div>
  <div class="card-body p-3">
    @if (!movimientos.Any())
    {
        <div class="p-3 text-muted">Sin movimientos recientes.</div>
    }
    else
    {
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle text-center">
            <thead>
              <tr>
                  <th class="text-center">Fecha</th>
                  <th class="text-center">Producto</th>
                  <th class="text-center">Tipo</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-center">Motivo</th>
              </tr>
            </thead>
            <tbody>
            @foreach (var m in movimientos)
            {
                var esIngreso = string.Equals(m.Tipo, "INGRESO", System.StringComparison.OrdinalIgnoreCase);
                var claseCant = esIngreso ? "text-success" : "text-danger";
                var signo = esIngreso ? "+" : "-";
                <tr>
                  <td class="text-center">@m.Fecha.LocalDateTime</td>
                  <td class="text-center">
                      <a asp-controller="Producto" asp-action="Details" asp-route-id="@m.ProductoId">
                          @(prodNames.ContainsKey(m.ProductoId) ? prodNames[m.ProductoId] : ("#" + m.ProductoId))
                      </a>
                  </td>
                  <td class="text-center">@(esIngreso ? "Ingreso" : "Egreso")</td>
                  <td class="text-center fw-semibold @claseCant">@signo@m.Cantidad</td>
                  <td class="text-center text-muted">@m.Motivo</td>
                </tr>
            }
            </tbody>
          </table>
        </div>
        <nav aria-label="Paginacion movimientos" class="p-2">
          <ul class="pagination pagination-sm justify-content-center mb-0">
            <li class="page-item @(page <= 1 ? "disabled" : "")">
              <a class="page-link" asp-action="Index" asp-route-page="@(page-1)">Anterior</a>
            </li>
            @for (var i = 1; i <= totalPages; i++)
            {
                <li class="page-item @(i == page ? "active" : "")">
                  <a class="page-link" asp-action="Index" asp-route-page="@i">@i</a>
                </li>
            }
            <li class="page-item @(page >= totalPages ? "disabled" : "")">
              <a class="page-link" asp-action="Index" asp-route-page="@(page+1)">Siguiente</a>
            </li>
          </ul>
        </nav>
    }
  </div>
</div>
