@model mi_ferreteria.ViewModels.StockCargaViewModel
@using mi_ferreteria.Models
@using System.Text.Json
@{
    var productos = ViewBag.Productos as IEnumerable<Producto> ?? Enumerable.Empty<Producto>();
    var stocks = ViewBag.Stocks as System.Collections.Generic.IDictionary<long, long> ?? new System.Collections.Generic.Dictionary<long, long>();
    var q = ViewBag.Query as string ?? string.Empty;
    int page = ViewBag.Page is int pageValue ? pageValue : 1;
    int totalPages = ViewBag.TotalPages is int tp ? tp : 1;
    var lineasIniciales = Model?.Lineas ?? new List<mi_ferreteria.ViewModels.StockCargaLineaViewModel>();
    var lineasJson = JsonSerializer.Serialize(lineasIniciales);
}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
        <h2 class="mb-0">Gestion de Stock</h2>
        <p class="text-muted mb-0">Selecciona productos desde el listado, indica cantidades y precios de compra para cargar stock en lote.</p>
    </div>
    <div>
        <a asp-action="Movimientos" class="btn btn-outline-primary">Ver ultimos movimientos</a>
    </div>
</div>

@if (TempData["StockOk"] != null)
{
    <div class="alert alert-success">@TempData["StockOk"]</div>
}
@if (TempData["StockError"] != null)
{
    <div class="alert alert-danger">@TempData["StockError"]</div>
}

<div class="card mb-3">
    <div class="card-body">
        <h4 class="mb-3">Productos</h4>
        <form method="get" asp-action="Index" class="mb-3">
            <div class="input-group">
                <input type="search"
                       id="buscadorProductos"
                       name="q"
                       value="@q"
                       class="form-control"
                       placeholder="Buscar por cualquier dato (SKU, nombre, descripcion, ubicacion, etc.)"
                       aria-label="Buscar productos" />
                <input type="hidden" name="page" value="1" />
                <button class="btn btn-primary" type="submit">Buscar</button>
                @if (!string.IsNullOrWhiteSpace(q))
                {
                    <a class="btn btn-outline-secondary" asp-action="Index">Limpiar</a>
                }
            </div>
        </form>

        @if (!productos.Any())
        {
            <div class="alert alert-info">No hay productos para mostrar.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>SKU</th>
                            <th>Nombre</th>
                            <th>Unidad</th>
                            <th>Stock</th>
                            <th class="text-end">Agregar</th>
                        </tr>
                    </thead>
                    <tbody id="productosBody">
                    @foreach (var p in productos)
                    {
                        var stock = stocks != null && stocks.TryGetValue(p.Id, out var s) ? s : 0;
                        <tr>
                            <td>@p.Id</td>
                            <td>@p.Sku</td>
                            <td>@p.Nombre</td>
                            <td>@p.UnidadMedida</td>
                            <td>@stock</td>
                            <td class="text-end">
                                <button type="button"
                                        class="btn btn-sm btn-success"
                                        data-id="@p.Id"
                                        data-sku="@p.Sku"
                                        data-nombre="@p.Nombre"
                                        data-unidad="@p.UnidadMedida"
                                        data-stock="@stock"
                                        onclick="agregarProductoDesdeBoton(this)">
                                    Agregar
                                </button>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>

            <nav id="paginacionProductos" aria-label="Paginacion de productos" class="mb-2">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item @(page <= 1 ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-q="@q"
                           asp-route-page="@(page - 1)">Anterior</a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">Pagina @(page) de @totalPages</span>
                    </li>
                    <li class="page-item @(page >= totalPages ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-q="@q"
                           asp-route-page="@(page + 1)">Siguiente</a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>

<div class="card mt-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0">Carga seleccionada</h4>
            <small class="text-muted">Cada linea se registrara como un ingreso de stock.</small>
        </div>
    </div>
    <div class="card-body">
        <form asp-action="Cargar" method="post" id="formCargas">
            @Html.AntiForgeryToken()
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Unidad</th>
                            <th style="width: 120px;">Cantidad</th>
                            <th style="width: 150px;">Precio compra</th>
                            <th>Stock actual</th>
                            <th style="width: 90px;"></th>
                        </tr>
                    </thead>
                    <tbody id="cargasBody">
                        <tr><td colspan="6" class="text-center text-muted">No hay productos seleccionados.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label asp-for="Motivo" class="form-label">Motivo (opcional)</label>
                    <input asp-for="Motivo" class="form-control" placeholder="Compra a proveedor, ajuste, inventario, etc." />
                    <span asp-validation-for="Motivo" class="text-danger"></span>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="mb-2 text-danger">
                        @Html.ValidationSummary()
                    </div>
                    <button type="submit" class="btn btn-primary" id="btnConfirmar" disabled>Registrar ingresos</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const lineasSeed = @Html.Raw(lineasJson);
        const lineas = Array.isArray(lineasSeed) ? [...lineasSeed] : [];
        const tbodyCargas = document.getElementById('cargasBody');
        const btnConfirmar = document.getElementById('btnConfirmar');

        function renderLineas() {
            if (!tbodyCargas) return;
            tbodyCargas.innerHTML = '';
            if (!lineas.length) {
                tbodyCargas.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay productos seleccionados.</td></tr>';
                if (btnConfirmar) btnConfirmar.disabled = true;
                return;
            }

            lineas.forEach((l, idx) => {
                const tr = document.createElement('tr');
                const nombre = l.ProductoNombre || ('#' + l.ProductoId);
                const unidad = l.UnidadMedida || 'unidad';
                const cantidad = (l.Cantidad && l.Cantidad > 0) ? l.Cantidad : 1;
                const precio = typeof l.PrecioCompra === 'number' ? l.PrecioCompra : '';
                const stockActual = typeof l.StockActual === 'number' ? l.StockActual : 0;

                tr.innerHTML = `
                    <td>
                        <input type="hidden" name="Lineas[${idx}].ProductoId" value="${l.ProductoId}" />
                        <input type="hidden" name="Lineas[${idx}].ProductoNombre" value="${nombre.replace(/\"/g, '')}" />
                        <input type="hidden" name="Lineas[${idx}].UnidadMedida" value="${unidad}" />
                        <input type="hidden" name="Lineas[${idx}].StockActual" value="${stockActual}" />
                        ${nombre}
                    </td>
                    <td>${unidad}</td>
                    <td>
                        <input type="number" class="form-control" min="1" step="1"
                               name="Lineas[${idx}].Cantidad"
                               value="${cantidad}"
                               data-idx="${idx}"
                               oninput="actualizarCantidad(this)" />
                    </td>
                    <td>
                        <input type="number" class="form-control" min="0" step="0.01"
                               name="Lineas[${idx}].PrecioCompra"
                               value="${precio !== '' ? precio : ''}"
                               data-idx="${idx}"
                               oninput="actualizarPrecio(this)" />
                    </td>
                    <td>${stockActual}</td>
                    <td class="text-end">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarLinea(${l.ProductoId})">Quitar</button>
                    </td>
                `;
                tbodyCargas.appendChild(tr);
            });
            if (btnConfirmar) btnConfirmar.disabled = false;
        }

        function agregarProductoDesdeBoton(btn) {
            const id = parseInt(btn.getAttribute('data-id') || '0', 10);
            if (!id) return;
            const existente = lineas.find(x => x.ProductoId === id);
            if (existente) {
                existente.Cantidad = (existente.Cantidad || 0) + 1;
                renderLineas();
                return;
            }
            const nombre = btn.getAttribute('data-nombre') || '';
            const unidad = btn.getAttribute('data-unidad') || 'unidad';
            const stock = parseInt(btn.getAttribute('data-stock') || '0', 10);

            lineas.push({
                ProductoId: id,
                ProductoNombre: nombre,
                UnidadMedida: unidad,
                Cantidad: 1,
                PrecioCompra: null,
                StockActual: isNaN(stock) ? 0 : stock
            });
            renderLineas();
        }

        function quitarLinea(productoId) {
            const idx = lineas.findIndex(x => x.ProductoId === productoId);
            if (idx >= 0) {
                lineas.splice(idx, 1);
                renderLineas();
            }
        }

        function actualizarCantidad(input) {
            const idx = parseInt(input.getAttribute('data-idx') || '-1', 10);
            if (idx < 0 || idx >= lineas.length) return;
            let val = parseInt(input.value || '0', 10);
            if (isNaN(val) || val < 1) val = 1;
            lineas[idx].Cantidad = val;
            input.value = val;
        }

        function actualizarPrecio(input) {
            const idx = parseInt(input.getAttribute('data-idx') || '-1', 10);
            if (idx < 0 || idx >= lineas.length) return;
            let val = parseFloat(input.value);
            if (isNaN(val) || val < 0) {
                lineas[idx].PrecioCompra = null;
                input.value = '';
                return;
            }
            lineas[idx].PrecioCompra = val;
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderLineas();

            const inputBusqueda = document.getElementById('buscadorProductos');
            const tbodyProductos = document.getElementById('productosBody');
            const paginacion = document.getElementById('paginacionProductos');
            const urlBuscarProductos = '@Url.Action("BuscarProductos", "Stock")';
            const htmlOriginalProductos = tbodyProductos ? tbodyProductos.innerHTML : '';
            let buscadorTimeoutId = null;

            if (inputBusqueda && tbodyProductos && urlBuscarProductos) {
                inputBusqueda.addEventListener('input', () => {
                    const termino = (inputBusqueda.value || '').trim();

                    if (buscadorTimeoutId) {
                        clearTimeout(buscadorTimeoutId);
                    }

                    buscadorTimeoutId = setTimeout(() => {
                        if (termino.length === 0) {
                            tbodyProductos.innerHTML = htmlOriginalProductos;
                            if (paginacion) paginacion.style.display = '';
                            return;
                        }

                        if (paginacion) paginacion.style.display = 'none';

                        fetch(urlBuscarProductos + '?q=' + encodeURIComponent(termino))
                            .then(r => r.ok ? r.json() : [])
                            .then(data => {
                                if (!Array.isArray(data)) return;
                                tbodyProductos.innerHTML = '';
                                data.forEach(p => {
                                    const tr = document.createElement('tr');
                                    const unidad = p.unidad || 'unidad';
                                    const stock = p.stock ?? 0;
                                    tr.innerHTML = `
                                        <td>${p.id}</td>
                                        <td>${p.sku || ''}</td>
                                        <td>${p.nombre || ''}</td>
                                        <td>${unidad}</td>
                                        <td>${stock}</td>
                                        <td class="text-end">
                                            <button type="button"
                                                    class="btn btn-sm btn-success"
                                                    data-id="${p.id}"
                                                    data-sku="${p.sku || ''}"
                                                    data-nombre="${p.nombre || ''}"
                                                    data-unidad="${unidad}"
                                                    data-stock="${stock}"
                                                    onclick="agregarProductoDesdeBoton(this)">
                                                Agregar
                                            </button>
                                        </td>`;
                                    tbodyProductos.appendChild(tr);
                                });
                            })
                            .catch(() => { /* ignorar errores de red */ });
                    }, 300);
                });
            }
        });
    </script>
}
