@model IEnumerable<mi_ferreteria.Models.Producto>
@using mi_ferreteria.ViewModels
@using System.Linq
@{
    ViewData["Title"] = "Productos";
}

<h2 class="mb-3">Productos</h2>
@{
    string q = ViewBag.Query as string ?? string.Empty;
    string sort = ViewBag.Sort as string ?? "id_asc";
    bool canManageProductos = User.IsInRole("Administrador") || User.IsInRole("Stock");
    string SortLabel(string s) {
        return s switch {
            "id_desc" => "ID (recientes)",
            "id_asc" => "ID (antiguos)",
            "nombre_asc" => "Nombre (A-Z)",
            "nombre_desc" => "Nombre (Z-A)",
            "precio_asc" => "Precio (menor?mayor)",
            "precio_desc" => "Precio (mayor?menor)",
            "stock_asc" => "Stock (menor?mayor)",
            "stock_desc" => "Stock (mayor?menor)",
            _ => "ID (recientes)"
        };
    }
}
<form method="get" asp-action="Index" class="mb-3">
    <div class="input-group">
        <input type="search" name="q" value="@q" class="form-control" placeholder="Buscar por cualquier dato (SKU, nombre, descripción, categoría, ubicación, código de barra)" aria-label="Buscar productos" />
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="sort" value="@sort" />
        <button class="btn btn-primary" type="submit">Buscar</button>
        @if (!string.IsNullOrWhiteSpace(q))
        {
            <a class="btn btn-outline-secondary" asp-action="Index">Limpiar</a>
        }
    </div>
</form>
@{
    string NextSort(string col) {
        return col switch {
            "id" => sort == "id_asc" ? "id_desc" : "id_asc",
            "nombre" => sort == "nombre_asc" ? "nombre_desc" : "nombre_asc",
            "precio" => sort == "precio_asc" ? "precio_desc" : "precio_asc",
            "stock" => sort == "stock_asc" ? "stock_desc" : "stock_asc",
            _ => "id_asc"
        };
    }
    string Arrow(string col) {
        if (col == "id" && sort.StartsWith("id_")) return sort.EndsWith("asc") ? "&uarr;" : "&darr;";
        if (col == "nombre" && sort.StartsWith("nombre_")) return sort.EndsWith("asc") ? "&uarr;" : "&darr;";
        if (col == "precio" && sort.StartsWith("precio_")) return sort.EndsWith("asc") ? "&uarr;" : "&darr;";
        if (col == "stock" && sort.StartsWith("stock_")) return sort.EndsWith("asc") ? "&uarr;" : "&darr;";
        // Mostrar flecha neutral cuando no es la columna activa
        return "&#8597;"; // ↕
    }
}
@* dropdown removed *@
@{
    var stocks = ViewBag.Stocks as System.Collections.Generic.IDictionary<long, long>;
    var stockCriticos = ViewBag.StockCriticos as System.Collections.Generic.HashSet<long> ?? new System.Collections.Generic.HashSet<long>();
    var detalleCriticos = ViewBag.StockCriticosDetalle as System.Collections.Generic.List<StockCriticoViewModel> ?? new System.Collections.Generic.List<StockCriticoViewModel>();
    var totalCriticos = ViewBag.StockCriticosCount is int sc ? sc : detalleCriticos.Count;
}
@* stocks: diccionario (ProductoId -> Stock actual) calculado en el controlador *@@{
    int page = ViewBag.Page is int ? (int)ViewBag.Page : 1;
    int totalPages = ViewBag.TotalPages is int ? (int)ViewBag.TotalPages : 1;
}
@* page y totalPages llegan desde el controlador para soportar la paginacion *@
@if (ViewBag.LoadError == true)
{
    <div class="alert alert-danger">No pudimos cargar los productos. Por favor, intenta nuevamente mas tarde.</div>
}
else if (totalCriticos > 0)
{
    var resumen = string.Join(", ", detalleCriticos.Take(4).Select(d => d.Nombre));
    if (detalleCriticos.Count > 4)
    {
        resumen += $" y {detalleCriticos.Count - 4} más";
    }
    <div class="alert alert-warning d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <strong>Atención:</strong> @totalCriticos producto@(totalCriticos == 1 ? "" : "s") están en stock crítico (igual o por debajo del mínimo).
            <span class="d-block small text-muted">@resumen</span>
        </div>
        <span class="badge bg-danger text-uppercase">Prioridad stock</span>
    </div>
}

@if (canManageProductos)
{
    <div class="text-center mb-4">
        @* Enlace de alta: preserva la pagina actual para volver luego *@
        <a asp-action="Create" asp-route-page="@(page)" class="btn btn-primary btn-lg btn-cta">Crear producto</a>
    </div>
}
@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">No hay productos cargados.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered align-middle table-products">
            <thead>
                <tr>
                    <th><a class="text-decoration-none" asp-action="Index" asp-route-q="@q" asp-route-sort='@NextSort("id")' asp-route-page="1">ID @Html.Raw(Arrow("id"))</a></th>
                    <th>SKU</th>
                    <th><a class="text-decoration-none" asp-action="Index" asp-route-q="@q" asp-route-sort='@NextSort("nombre")' asp-route-page="1">Nombre @Html.Raw(Arrow("nombre"))</a></th>
                    <th><a class="text-decoration-none" asp-action="Index" asp-route-q="@q" asp-route-sort='@NextSort("precio")' asp-route-page="1">Precio @Html.Raw(Arrow("precio"))</a></th>
                    <th>Ubicación</th>
                    <th><a class="text-decoration-none" asp-action="Index" asp-route-q="@q" asp-route-sort='@NextSort("stock")' asp-route-page="1">Stock @Html.Raw(Arrow("stock"))</a></th>
                    <th>Activo</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
            @* Renderiza filas de productos. Cada fila es "clickeable" para ir a Detalle *@
            @foreach (var p in Model)
            {
                var stockActual = (stocks != null && stocks.ContainsKey(p.Id)) ? stocks[p.Id] : 0;
                var esCritico = stockCriticos.Contains(p.Id);
                var rowClasses = "clickable-row" + (esCritico ? " table-warning" : string.Empty);
                <tr class="@rowClasses" data-href="@Url.Action("Details","Producto", new { id = p.Id, page = page, q = q, sort = sort })">
                    <td>@p.Id</td>
                    <td>@p.Sku</td>
                    <td>@p.Nombre</td>
                    <td>$ @p.PrecioVentaActual</td>
                    <td>@(string.IsNullOrWhiteSpace(p.UbicacionCodigo) ? "-" : p.UbicacionCodigo)</td>
                    <td>
                        @stockActual
                        @if (esCritico)
                        {
                            <span class="badge bg-danger ms-1">Stock crítico</span>
                        }
                    </td>
                    <td class="text-center">
                        @if (p.Activo) { <span class="badge bg-success">Sí</span>; } else { <span class="badge bg-secondary">No</span>; }
                    </td>
                    <td class="text-end">
                        <a asp-action="Details" asp-route-id="@p.Id" asp-route-page="@(page)" asp-route-q="@q"  asp-route-sort="@sort" class="btn btn-sm btn-outline-info">Ver</a>
                        @if (canManageProductos)
                        {
                            <a asp-action="Edit" asp-route-id="@p.Id" asp-route-page="@(page)" asp-route-q="@q"  asp-route-sort="@sort" class="btn btn-sm btn-outline-primary">Editar</a>
                        }
                        <a asp-controller="StockProducto" asp-action="Manage" asp-route-id="@p.Id" class="btn btn-sm btn-outline-secondary">Stock</a>
                        @if (canManageProductos)
                        {
                            <a asp-action="Delete" asp-route-id="@p.Id" asp-route-page="@(page)" asp-route-q="@q"  asp-route-sort="@sort" class="btn btn-sm btn-outline-danger btn-delete-prod">Eliminar</a>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    @* Controles de paginación (Bootstrap): Anterior, números y Siguiente *@
    @if (totalPages > 1)
    {
        var start = Math.Max(1, page - 2);
        var end = Math.Min(totalPages, page + 2);
        <nav aria-label="Paginación de productos" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item @(page <= 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(page - 1)" asp-route-q="@q" asp-route-sort="@sort">Anterior</a>
                </li>
                @for (var i = start; i <= end; i++)
                {
                    <li class="page-item @(i == page ? "active" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-q="@q" asp-route-sort="@sort">@i</a>
                    </li>
                }
                <li class="page-item @(page >= totalPages ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" asp-route-page="@(page + 1)" asp-route-q="@q" asp-route-sort="@sort">Siguiente</a>
                </li>
            </ul>
        </nav>
    }
}

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function(){
  // Confirmación de eliminación desde el listado
  document.querySelectorAll('.btn-delete-prod').forEach(function(a){
    a.addEventListener('click', function(e){
    if(!confirm('¿Seguro que deseas eliminar este producto?')){
        e.preventDefault();
      }
    });
  });

  // Click en fila -> navega a Detalle (excepto si haces click en botones/enlaces dentro de la fila)
  document.querySelectorAll('table.table-products tbody tr.clickable-row').forEach(function(tr){
    tr.addEventListener('click', function(e){
      var t = e.target;
      if (t && t.closest && (t.closest('a') || t.closest('button'))) return;
      var href = this.getAttribute('data-href');
      if (href) window.location.href = href;
    });
  });

  // Inicializa dropdowns (Bootstrap 5 o 4 fallback)
  try {
    if (window.bootstrap && bootstrap.Dropdown) {
      document.querySelectorAll('.dropdown-toggle').forEach(function(el){ new bootstrap.Dropdown(el); });
    } else if (window.jQuery && typeof jQuery.fn.dropdown === 'function') {
      jQuery('.dropdown-toggle').dropdown();
    }
  } catch(e) { /* noop */ }

  // Busqueda con debounce para evitar multiples requests mientras se escribe
  const qInput = document.querySelector('form[method="get"] input[name="q"]');
  const form = qInput && qInput.closest('form');
  if (qInput && form) {
    let timer;
    qInput.addEventListener('input', function(){
      clearTimeout(timer);
      // Reinicia a pagina 1 cada vez que cambia el query
      const pageField = form.querySelector('input[name="page"]');
      if (pageField) pageField.value = '1';
      timer = setTimeout(() => { form.requestSubmit(); }, 300);
    });
  }
});
</script>
}
<!--








  // Búsqueda con debounce para evitar múltiples requests mientras se escribe
  const qInput = document.querySelector('form[method="get"] input[name="q"]');
  const form = qInput && qInput.closest('form');
  if (qInput && form) {
    let timer;
    qInput.addEventListener('input', function(){
      clearTimeout(timer);
      // Reinicia a página 1 cada vez que cambia el query
      const pageField = form.querySelector('input[name="page"]');
      if (pageField) pageField.value = '1';
      timer = setTimeout(() => { form.requestSubmit(); }, 300);
    });
  }
-->




