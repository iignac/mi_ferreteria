@model IEnumerable<mi_ferreteria.Models.Cliente>
@{
    ViewData["Title"] = "Clientes";
    string q = ViewBag.Query as string ?? string.Empty;
    int page = ViewBag.Page is int ? (int)ViewBag.Page : 1;
    int totalPages = ViewBag.TotalPages is int ? (int)ViewBag.TotalPages : 1;
}

<h2 class="mb-3">Clientes</h2>

<form method="get" asp-action="Index" class="mb-3">
    <div class="input-group">
        <input type="search" name="q" value="@q" class="form-control"
               placeholder="Buscar por nombre, documento o email" aria-label="Buscar clientes" />
        <input type="hidden" name="page" value="1" />
        <button class="btn btn-primary" type="submit">Buscar</button>
        @if (!string.IsNullOrWhiteSpace(q))
        {
            <a class="btn btn-outline-secondary" asp-action="Index">Limpiar</a>
        }
    </div>
</form>

<div class="text-center mb-4">
    <a asp-action="Create" class="btn btn-primary btn-lg">Crear cliente</a>
</div>

@if (Model == null || !Model.Any())
{
    <div class="alert alert-info">No hay clientes cargados.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered align-middle text-center">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre / Razón social</th>
                    <th>Apellido</th>
                    <th>Documento</th>
                    <th>Tipo cliente</th>
                    <th>Dirección</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Cuenta corriente</th>
                    <th>Límite crédito</th>
                    <th>Activo</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var c in Model)
            {
                <tr>
                    <td>@c.Id</td>
                    <td>@c.Nombre</td>
                    <td>@(string.IsNullOrWhiteSpace(c.Apellido) ? "-" : c.Apellido)</td>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(c.TipoDocumento) || !string.IsNullOrWhiteSpace(c.NumeroDocumento))
                        {
                            @($"{c.TipoDocumento} {c.NumeroDocumento}")
                        }
                        else
                        {
                            @("-")
                        }
                    </td>
                    <td>@(c.TipoCliente == "CUENTA_CORRIENTE" ? "Cuenta corriente" : "Consumidor final")</td>
                    <td>@(string.IsNullOrWhiteSpace(c.Direccion) ? "-" : c.Direccion)</td>
                    <td>@(string.IsNullOrWhiteSpace(c.Telefono) ? "-" : c.Telefono)</td>
                    <td>@(string.IsNullOrWhiteSpace(c.Email) ? "-" : c.Email)</td>
                    <td>
                        @(c.CuentaCorrienteHabilitada ? "Sí" : "No")
                    </td>
                    <td>
                        @(c.CuentaCorrienteHabilitada ? c.LimiteCredito.ToString("N2") : "-")
                    </td>
                    <td>
                        @if (c.Activo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td class="text-end">
                        <a asp-action="Edit" asp-route-id="@c.Id" class="btn btn-sm btn-outline-primary">Editar</a>
                        @if (c.Activo)
                        {
                            <form asp-action="Delete" asp-route-id="@c.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('¿Dar de baja este cliente?');">Baja</button>
                            </form>
                        }
                        else
                        {
                            <form asp-action="Activate" asp-route-id="@c.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-success">Activar</button>
                            </form>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    @if (totalPages > 1)
    {
        var start = System.Math.Max(1, page - 2);
        var end = System.Math.Min(totalPages, page + 2);
        <nav aria-label="Paginación clientes" class="mt-3">
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item @(page <= 1 ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-page="@(page - 1)">Anterior</a>
                </li>
                @for (var i = start; i <= end; i++)
                {
                    <li class="page-item @(i == page ? "active" : "")">
                        <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-page="@i">@i</a>
                    </li>
                }
                <li class="page-item @(page >= totalPages ? "disabled" : "")">
                    <a class="page-link" asp-action="Index" asp-route-q="@q" asp-route-page="@(page + 1)">Siguiente</a>
                </li>
            </ul>
        </nav>
    }
}
